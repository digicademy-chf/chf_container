## DATA SOURCES ####################################################################################

source t3_dfd : base
{
    # STANDARD ATTRIBUTES

    sql_db              = t3_dfd
    sql_query_pre       = SET NAMES utf8
    sql_attr_uint       = uid
    sql_attr_uint       = pid
    # sql_attr_timestamp  = tstamp -> 'key 'sql_attr_timestamp' was permanently removed (see documentation for details)'
    sql_attr_bool       = hidden
    sql_attr_bool       = deleted
    sql_attr_uint       = sys_language_uid
    sql_attr_string     = sorting
    sql_attr_string     = persistent_identifier
    sql_attr_uint       = gender
    sql_attr_string     = honorific_prefix
    sql_attr_string     = given_name
    sql_attr_string     = additional_name
    sql_attr_string     = family_name
    sql_attr_string     = honorific_suffix
    sql_attr_string     = university
    sql_attr_string     = disciplines

    # FACET ATTRIBUTES

    sql_attr_uint       = universities_facet

    sql_attr_multi      = uint disciplines_facet from query; \
                          SELECT tx_expertdb_person_discipline_mm.uid_local, tx_expertdb_person_discipline_mm.uid_foreign \
                          FROM tx_expertdb_person_discipline_mm \
                          LEFT JOIN tx_dmdb_domain_model_discipline_taxonomy \
                            ON tx_expertdb_person_discipline_mm.uid_foreign = tx_dmdb_domain_model_discipline_taxonomy.uid \
                          WHERE tx_dmdb_domain_model_discipline_taxonomy.hidden = 0 \
                          AND tx_dmdb_domain_model_discipline_taxonomy.deleted = 0

# the static tables have no hidden field

    sql_attr_multi      = uint countries_facet from query; \
                          SELECT uid_local, uid_foreign \
                          FROM tx_expertdb_person_country_mm \
                          LEFT JOIN static_countries \
                            ON tx_expertdb_person_country_mm.uid_foreign = static_countries.uid \
                          WHERE static_countries.deleted = 0

    sql_attr_multi      = uint territories_facet from query; \
                          SELECT uid_local, uid_foreign \
                          FROM tx_expertdb_person_territory_mm \
                          LEFT JOIN static_territories\
                            ON tx_expertdb_person_territory_mm.uid_foreign = static_territories.uid \
                          WHERE static_territories.deleted = 0

    sql_attr_multi      = uint languages_facet from query; \
                          SELECT uid_local, uid_foreign \
                          FROM tx_expertdb_person_language_mm \
                          LEFT JOIN static_languages \
                            ON tx_expertdb_person_language_mm.uid_foreign = static_languages.uid \
                          WHERE static_languages.deleted = 0

    sql_attr_multi      = uint era_facet from query; \
                          SELECT uid_local, uid_foreign \
                          FROM tx_expertdb_person_era_mm \
                          LEFT JOIN tx_chftime_domain_model_temporal_entity AS era\
                            ON tx_expertdb_person_era_mm.uid_foreign = era.uid \
                          WHERE era.hidden = 0 \
                          AND era.deleted = 0 \
                          AND era.pid IN (57)

    sql_attr_multi      = uint temporal_entity_facet from query; \
                          SELECT uid_local, uid_foreign \
                          FROM tx_expertdb_person_temporal_entity_mm \
                          LEFT JOIN tx_chftime_domain_model_temporal_entity AS temporal_entity \
                            ON tx_expertdb_person_temporal_entity_mm.uid_foreign = temporal_entity.uid \
                          WHERE temporal_entity.hidden = 0 \
                          AND temporal_entity.deleted = 0 \
                          AND temporal_entity.pid IN (56)

}

source tx_academy_domain_model_persons_query : t3_pkf
{
    sql_query           = \
        SELECT \
            tx_academy_domain_model_persons.uid AS docid, \
            tx_academy_domain_model_persons.uid AS uid, \
            tx_academy_domain_model_persons.pid AS pid, \
            tx_academy_domain_model_persons.tstamp AS tstamp, \
            tx_academy_domain_model_persons.hidden AS hidden, \
            tx_academy_domain_model_persons.deleted AS deleted, \
            tx_academy_domain_model_persons.sys_language_uid AS sys_language_uid, \
            tx_academy_domain_model_persons.sorting AS sorting, \
            tx_academy_domain_model_persons.persistent_identifier AS persistent_identifier, \
            tx_academy_domain_model_persons.gender AS gender, \
            tx_academy_domain_model_persons.honorific_prefix AS honorific_prefix, \
            tx_academy_domain_model_persons.given_name AS given_name, \
            tx_academy_domain_model_persons.additional_name AS additional_name, \
            tx_academy_domain_model_persons.family_name AS family_name, \
            tx_academy_domain_model_persons.honorific_suffix AS honorific_suffix, \
            tx_dmdb_domain_model_university.name AS university, \
            tx_dmdb_domain_model_university.uid AS universities_facet, \
            GROUP_CONCAT(DISTINCT tx_dmdb_domain_model_discipline_taxonomy.name) AS taxonomy_name_fulltext, \
            GROUP_CONCAT(DISTINCT tx_dmdb_domain_model_discipline_taxonomy.name SEPARATOR ', ') AS disciplines, \
            CONCAT_WS(' ',\
                tx_academy_domain_model_persons.given_name,\
                tx_academy_domain_model_persons.additional_name,\
                tx_academy_domain_model_persons.family_name\
            ) AS name_fulltext, \
            tx_academy_domain_model_persons.professorship_label AS professorship_label_fulltext, \
            tx_dmdb_domain_model_university.name AS university_fulltext, \
            static_countries.cn_short_de AS country_fulltext, \
            static_territories.tr_name_de AS territory_fulltext, \
            static_languages.lg_name_de AS language_fulltext, \
            era.name AS era_fulltext, \
            temporal_entity.name AS temporal_entity_fulltext, \
            tx_academy_domain_model_persons.research_focus AS research_focus_fulltext, \
            tx_academy_domain_model_projects.title AS projects_fulltext, \
            tx_academy_domain_model_persons.roles AS roles_fulltext, \
            tx_academy_domain_model_persons.special_expertise AS special_expertise_fulltext \
        FROM \
            tx_academy_domain_model_persons \
        LEFT JOIN \
            tx_expertdb_person_discipline_mm \
                ON tx_academy_domain_model_persons.uid = tx_expertdb_person_discipline_mm.uid_local \
        LEFT JOIN \
            tx_dmdb_domain_model_discipline_taxonomy \
                ON tx_dmdb_domain_model_discipline_taxonomy.uid = tx_expertdb_person_discipline_mm.uid_foreign \
                AND tx_dmdb_domain_model_discipline_taxonomy.hidden = 0 \
                AND tx_dmdb_domain_model_discipline_taxonomy.deleted = 0 \
                AND tx_dmdb_domain_model_discipline_taxonomy.pid IN (13) \
        LEFT JOIN \
            tx_dmdb_domain_model_university \
                ON tx_dmdb_domain_model_university.uid = tx_academy_domain_model_persons.university \
                AND tx_dmdb_domain_model_university.hidden = 0 \
                AND tx_dmdb_domain_model_university.deleted = 0 \
                AND tx_dmdb_domain_model_university.pid IN (17, 98) \
        LEFT JOIN \
            tx_expertdb_person_country_mm \
                ON tx_academy_domain_model_persons.uid = tx_expertdb_person_country_mm.uid_local \
        LEFT JOIN \
            static_countries \
                ON static_countries.uid = tx_expertdb_person_country_mm.uid_foreign \
        LEFT JOIN \
            tx_expertdb_person_territory_mm \
                ON tx_academy_domain_model_persons.uid = tx_expertdb_person_territory_mm.uid_local \
        LEFT JOIN \
            static_territories \
                ON static_territories.uid = tx_expertdb_person_territory_mm.uid_foreign \
        LEFT JOIN \
            tx_expertdb_person_language_mm \
                ON tx_academy_domain_model_persons.uid = tx_expertdb_person_language_mm.uid_foreign \
        LEFT JOIN \
            static_languages \
                ON static_languages.uid = tx_expertdb_person_language_mm.uid_foreign \
        LEFT JOIN \
            tx_expertdb_person_era_mm \
                ON tx_academy_domain_model_persons.uid = tx_expertdb_person_era_mm.uid_local \
        LEFT JOIN \
            tx_chftime_domain_model_temporal_entity AS era \
                ON era.uid = tx_expertdb_person_era_mm.uid_foreign \
                AND era.pid IN (57) \
        LEFT JOIN \
            tx_expertdb_person_temporal_entity_mm \
                ON tx_academy_domain_model_persons.uid = tx_expertdb_person_temporal_entity_mm.uid_local \
        LEFT JOIN \
            tx_chftime_domain_model_temporal_entity AS temporal_entity \
                ON temporal_entity.uid = tx_expertdb_person_temporal_entity_mm.uid_foreign \
                AND temporal_entity.hidden = 0 \
                AND temporal_entity.deleted = 0 \
                AND temporal_entity.pid IN (56) \
        LEFT JOIN \
            tx_academy_domain_model_relations \
                ON tx_academy_domain_model_persons.uid = tx_academy_domain_model_relations.person \
                AND tx_academy_domain_model_relations.deleted = 0 \
                AND tx_academy_domain_model_relations.hidden = 0 \
                AND tx_academy_domain_model_relations.pid IN (94) \
        LEFT JOIN \
            tx_academy_domain_model_projects \
                ON tx_academy_domain_model_projects.uid = tx_academy_domain_model_relations.project \
                AND tx_academy_domain_model_projects.hidden = 0 \
                AND tx_academy_domain_model_projects.deleted = 0 \
                AND tx_academy_domain_model_projects.pid IN (91) \
        WHERE \
            tx_academy_domain_model_persons.deleted = 0 \
            AND tx_academy_domain_model_persons.hidden = 0 \
            AND tx_academy_domain_model_persons.pid IN (90,30) \
        GROUP BY \
            tx_academy_domain_model_persons.uid\
        ORDER BY \
            tx_academy_domain_model_persons.uid
}

## INDEXES ###########################################################################################

# Charset table of allowed/supported characters in this index:
#
# 0..9           Any number 0-9
# A..Z           Uppercase latin characters A-Z, converted to lowercase
# a..z           Lowercase latin characters a-z (meaning the ASCII range is now all lowercase)
# U+80..U+FF     Latin-1 Supplement characters 'as is' - http://www.fileformat.info/info/unicode/block/latin_supplement/list.htm
# U+100..U+17F   Latin Extended-A characters 'as is' - http://www.fileformat.info/info/unicode/block/latin_extended_a/list.htm
# U+180..U+24F   Latin Extended-B characters 'as is' - http://www.fileformat.info/info/unicode/block/latin_extended_b/list.htm
# U+300..U+36F   Combining Diacritical Marks 'as is' - http://www.fileformat.info/info/unicode/block/combining_diacritical_marks/list.htm
# U+1DC0..U+1DFF Combining Diacritical Marks Supplement 'as is' - http://www.fileformat.info/info/unicode/block/combining_diacritical_marks_supplement/list.htm
# U+370..U+3E1   Greek characters 'as is' - http://www.fileformat.info/info/unicode/block/greek_and_coptic/list.htm
# U+591..U+5F4   Hebrew characters 'as is' - http://www.fileformat.info/info/unicode/block/hebrew/list.htm
# U+400..U+4FF   Cyrillic characters 'as is' - http://www.fileformat.info/info/unicode/block/cyrillic/list.htm
# U+500..U+8FF   Cyrillic Supplement 'as is' - http://www.fileformat.info/info/unicode/block/cyrillic_supplement/list.htm

index tx_academy_domain_model_persons
{
    source          = tx_academy_domain_model_persons_query
    path            = /opt/sphinx/index/tx_academy_domain_model_persons
    charset_table   = 0..9, \
                      A..Z->a..z, \
                      a..z, \
                      U+80..U+FF, \
                      U+100..U+17F, \
                      U+180..U+24F, \
                      U+300..U+36F, \
                      U+1DC0..U+1DFF, \
                      U+370..U+3E1, \
                      U+591..U+5F4, \
                      U+400..U+4FF, \
                      U+500..U+8FF
    ignore_chars    = U+27, U+28, U+29, U+5B, U+5D, U+7B, U+7D # ignores '()[]{}
#   stopwords       =
#    morphology      = libstemmer_de
#    min_stemming_len = 4
    min_word_len    = 1
#    infix_fields    =
    min_infix_len   = 2
    html_strip      = 1
    html_remove_elements = style, script
    index_sp        = 1
}
